
sampler2D texDif;

sampler2D texDet[4];
sampler2D texColor;

struct PSInput
{
    float2 TexCoord1 : TEXCOORD0; 
    float2 TexCoord2 : TEXCOORD1; 
    float3 Normal : TEXCOORD2;
};

struct PSOutput
{
    float4 Color : COLOR;
};

PSOutput main(PSInput ip)
{
    PSOutput o;
    float3 lightDir = float3(1,0,0);
    float ndl = dot(ip.Normal, lightDir);
	
	float4 index = tex2D(texDif, ip.TexCoord1);
	
	float4 color = 0;
	
	int i;
	for (i=0;i<4;i++)
	{
		if (index[i]>0.01)
		{
			color += (index[i]) * tex2D(texDet[i], ip.TexCoord2);
			color += (index[i]) * tex2D(texDet[i], ip.TexCoord2*7);
		}
	}
	
    o.Color = color * (0.5 * tex2D(texColor, ip.TexCoord1)) * max( 0.3, ndl );
    return o;
}
