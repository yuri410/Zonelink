#include "waterDepth.psh"

sampler2D texDet[4];
sampler2D texDif : register(s4);
sampler2D texColor : register(s5);
sampler2D texNrm : register(s6);

struct PSInput
{
    float2 GlobeCoord : TEXCOORD0; 
    float2 DetailCoord : TEXCOORD1; 
    
	float3 TangentSpaceLDir : TEXCOORD6;
    float WaterDepth : TEXCOORD7;
};

struct PSOutput
{
    float4 Color : COLOR;
};

PSOutput main(PSInput ip)
{
    PSOutput o;
    
    float3 N = 2 * (float3)tex2D(texNrm, ip.DetailCoord) - 1;
    
    // 地形法线贴图要转换为切线空间的
	float tmp = N.z;
	N.z = N.y;
	N.y = tmp;
  
    float ndl = max(0, dot(N, ip.TangentSpaceLDir));
	
	float4 index = tex2D(texDif, ip.GlobeCoord);
	
	float4 color = 0;
	
	int i;
	for (i=0;i<4;i++)
	{
		if (index[i]>0.01)
		{
			color += (index[i]) * tex2D(texDet[i], ip.DetailCoord*3);
			color += (index[i]) * tex2D(texDet[i], ip.DetailCoord*21);
		}
	}
	
    o.Color = ndl * ((color * 0.5) * tex2D(texColor, ip.GlobeCoord));
    o.Color = GetColor(o.Color, ip.WaterDepth);
    return o;
}
